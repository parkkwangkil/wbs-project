{% extends 'base.html' %}

{% block title %}{{ project.title }} - WBS Project Management{% endblock %}

{% block page_title %}{{ project.title }}{% endblock %}

{% block content %}
<div class="grid grid-cols-1">
    <!-- Project Header -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="avatar avatar-lg {{ project.color_theme }}" style="color: white;">
                    <i class="fas fa-project-diagram"></i>
                </div>
                <div>
                    <h2 class="card-title" style="margin-bottom: 0.5rem;">{{ project.title }}</h2>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span class="status-badge status-{{ project.status }}">{{ project.get_status_display }}</span>
                        <span style="color: var(--text-secondary); font-size: 0.875rem;">
                            <i class="fas fa-user-tie" style="margin-right: 0.25rem;"></i>
                            {{ project.manager.username }}
                        </span>
                        <span style="color: var(--text-secondary); font-size: 0.875rem;">
                            <i class="fas fa-calendar" style="margin-right: 0.25rem;"></i>
                            {{ project.start_date }} ~ {{ project.end_date }}
                        </span>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                {% if user.is_staff or user.id == project.manager_id %}
                <a href="{% url 'wbs:project_edit' project.pk %}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-edit"></i>
                    Edit
                </a>
                <form action="{% url 'wbs:project_delete' project.pk %}" method="post" onsubmit="return confirm('정말 삭제하시겠습니까?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-secondary btn-sm" style="background:#ef4444;border:none;color:#fff;">
                        <i class="fas fa-trash"></i>
                        Delete
                    </button>
                </form>
                {% endif %}
                <a href="{% url 'wbs:project_planner' project.pk %}" class="btn btn-secondary btn-sm">
                    <i class="fas fa-table"></i>
                    Planner
                </a>
                <a href="{% url 'wbs:progress_calendar' project.pk %}" class="btn btn-primary btn-sm">
                    <i class="fas fa-calendar-check"></i>
                    Progress
                </a>
            </div>
        </div>
        <div class="card-body">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;">
                <div style="font-weight:700;color:var(--text-heading);">
                    주간: {{ week_start|date:'m/d' }} - {{ week_end|date:'m/d' }}
                </div>
                <div style="display:flex;gap:.5rem;">
                    <a class="btn btn-secondary btn-sm" href="{% url 'wbs:project_detail' project.pk %}?week={{ prev_week }}">이전 주</a>
                    <a class="btn btn-secondary btn-sm" href="{% url 'wbs:project_detail' project.pk %}?week={{ next_week }}">다음 주</a>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
                <!-- Project Description -->
                <div>
                    <h3 style="color: var(--text-heading); font-weight: 600; margin-bottom: 1rem;">Description</h3>
                    <p style="color: var(--text-body); line-height: 1.6;">{{ project.description }}</p>
                </div>

                <!-- Project Stats -->
                <div>
                    <h3 style="color: var(--text-heading); font-weight: 600; margin-bottom: 1rem;">Project Stats</h3>
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <span style="color: var(--text-secondary); font-size: 0.875rem;">Progress</span>
                                <span style="color: var(--text-heading); font-weight: 600;">{{ project.progress }}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: {{ project.progress }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- WBS Table (weekly) -->
    <div class="card">
        <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
            <div style="display:flex;align-items:center;gap:.75rem;">
                <h2 class="card-title" style="margin:0;display:flex;align-items:center;gap:.5rem;"><i class="fas fa-sitemap" style="color:var(--text-secondary);"></i>WBS</h2>
                <div style="color:var(--text-heading);font-weight:700;">({{ week_start|date:'m/d' }} - {{ week_end|date:'m/d' }})</div>
                <div style="display:flex;gap:.5rem;align-items:center;">
                    <span class="btn btn-primary btn-sm" aria-current="true">주간</span>
                    <span class="btn btn-secondary btn-sm" style="opacity:.6;pointer-events:none;">월간</span>
                </div>
            </div>
            <div style="display:flex;gap:.5rem;align-items:center;">
                <a class="btn btn-secondary btn-sm" href="{% url 'wbs:project_detail' project.pk %}?week={{ prev_week }}" title="이전 주"><i class="fas fa-chevron-left"></i></a>
                <a class="btn btn-secondary btn-sm" href="{% url 'wbs:project_detail' project.pk %}?week={{ next_week }}" title="다음 주"><i class="fas fa-chevron-right"></i></a>
                <a class="btn btn-secondary btn-sm" href="{% url 'wbs:project_detail' project.pk %}?week={{ week_start|date:'Y-m-d' }}" title="새로고침"><i class="fas fa-sync-alt"></i> 새로고침</a>
            </div>
        </div>
        <div class="card-body">
            <style>
                .wbs thead th{background:var(--sidebar-hover);color:var(--text-heading);font-weight:700;padding:.5rem;border:1px solid var(--card-border)}
                .wbs tbody td{padding:.5rem;border:1px solid var(--card-border);vertical-align:middle;font-size:.9rem}
                .wbs tbody tr:nth-child(odd) td{background:var(--bg-surface)}
                .right-grid{position:relative;min-height:28px;overflow:hidden}
                .grid-bar{position:absolute;top:4px;height:20px;border-radius:10px;color:#fff;font-size:12px;display:flex;align-items:center;padding:0 10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;box-shadow:0 6px 16px rgba(0,0,0,.12);border:1px solid rgba(0,0,0,.06)}
            </style>

            <table class="wbs" style="width:100%;border-collapse:separate;border-spacing:0;">
                <colgroup>
                    <col style="width: 140px;">
                    <col style="width: 260px;">
                    <col style="width: 120px;">
                    <col style="width: 160px;">
                    <col style="width: 100px;"> <!-- 상태 -->
                    <col style="width: 100px;">
                    <col style="width: 100px;">
                    <col style="width: 80px;">
                    <col>
                </colgroup>
                <thead>
                    <tr>
                        <th>항목</th>
                        <th>내용</th>
                        <th>팀</th>
                        <th>담당자</th>
                        <th>상태</th>
                        <th>시작일</th>
                        <th>종료일</th>
                        <th>시간(h)</th>
                        <th>
                            <div class="right-grid" style="height:28px;display:grid;grid-template-columns:repeat(7, {{ px_per_day }}px);">
                                {% for d in week_days %}
                                <div style="border-right:1px solid var(--card-border);text-align:center;color:var(--text-secondary);font-weight:600;">{{ d|date:'m/d' }}</div>
                                {% endfor %}
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in phase_rows %}
                        <tr>
                            <td>{{ r.title }}</td>
                            <td>{{ r.description|default:'-' }}</td>
                            <td>{{ r.team|default:'-' }}</td>
                            <td>{{ r.owner }}</td>
                            <td>{% if r.status == 'planned' %}계획{% elif r.status == 'in_progress' %}진행중{% elif r.status == 'blocked' %}보류{% elif r.status == 'done' %}완료{% else %}{{ r.status }}{% endif %}</td>
                            <td>{{ r.start_date }}</td>
                            <td>{{ r.end_date }}</td>
                            <td style="text-align:right;">{{ r.daily_hours }}</td>
                            <td>
                                <div class="right-grid" style="height:28px;display:grid;grid-template-columns:repeat(7, {{ px_per_day }}px); position:relative;">
                                    <div class="grid-bar" style="left: {{ r.left }}px; width: {{ r.width }}px; background: {{ project.theme_color }};">{{ r.title }}</div>
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr><td colspan="8" style="text-align:center;color:var(--text-secondary);padding:1rem;">단계가 없습니다. 우측 상단의 '단계 추가'를 눌러 추가하세요.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Project Phases -->
    <div class="card">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="card-title">
                <i class="fas fa-tasks" style="margin-right: 0.5rem; color: var(--text-secondary);"></i>
                Project Phases
            </h2>
            <a href="{% url 'wbs:phase_create' project.pk %}" class="btn btn-primary btn-sm">
                <i class="fas fa-plus"></i>
                Add Phase
            </a>
        </div>
        <div class="card-body">
            {% if project.phases.all %}
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    {% for phase in project.phases.all %}
                        <div class="card" style="padding: 1rem; border: 1px solid var(--card-border);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem;">
                                <div style="flex: 1;">
                                    <h3 style="color: var(--text-heading); font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">
                                        {{ phase.title }}
                                    </h3>
                                    <p style="color: var(--text-secondary); font-size: 0.875rem;">
                                        {{ phase.description|truncatewords:20 }}
                                    </p>
                                </div>
                                <span class="status-badge status-{{ phase.status }}">
                                    {{ phase.get_status_display|default:phase.status }}
                                </span>
                            </div>

                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 0.75rem;">
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">팀</div>
                                    <div style="color: var(--text-heading); font-size: 0.875rem;">{{ phase.team_name|default:'-' }}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">담당자</div>
                                    <div style="color: var(--text-heading); font-size: 0.875rem;">{% for u in phase.assignees.all %}{% if not forloop.first %}, {% endif %}{{ u.username }}{% empty %}-{% endfor %}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">시간(h)</div>
                                    <div style="color: var(--text-heading); font-size: 0.875rem;">{{ phase.daily_hours }}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); font-size: 0.75rem; margin-bottom: 0.25rem;">진행률</div>
                                    <div style="color: var(--text-heading); font-size: 0.875rem; font-weight: 600;">{{ phase.progress }}%</div>
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                <a href="{% url 'wbs:phase_edit' project.pk phase.pk %}" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-edit"></i>
                                    Edit
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div style="text-align: center; padding: 2rem 1rem; color: var(--text-secondary);">
                    <i class="fas fa-tasks" style="font-size: 2rem; margin-bottom: 1rem; color: var(--text-disabled);"></i>
                    <p style="margin-bottom: 1rem;">No phases defined yet</p>
                    <a href="{% url 'wbs:phase_create' project.pk %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus"></i>
                        Add First Phase
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
